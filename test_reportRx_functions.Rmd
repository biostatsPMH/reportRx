---
title: "reportRx TestFile"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::word_document2:
    reference_docx: 'wordTemplate.docx'
    toc: yes
  bookdown::pdf_document2:
    latex_engine: xelatex
sansfont: Calibri Light
mainfont: Calibri Light
bibliography:
  - bibfile.bib
#csl: Vancouver.csl
link-citations: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
#library(survival)
library(reportRx)
library(tidyverse)

# Uncomment to create the packages.bib file of R packages used
#reportRx::rmdBibfile(bibfile = 'masterfile.bib',outfile = 'bibfile.bib')

```


\newpage
# Introduction {-}


First, make some changes to the lung data (cancer in the newer version of survival)

```{r echo=T}
data(cancer, package='survival')
lung <- cancer

lung <- lung %>%
  mutate(
    Status=factor(status-1),
    Sex = factor(sex,labels = c('Male','Female')),
    AgeGroup = cut(age, breaks=seq(0,100,10)),
    OneLevelFactor = factor(x='one level')
  ) %>%
  arrange(Status)

lung$x_null = rnorm(nrow(lung))
lung$x_pred = c(rnorm(sum(lung$Status==0),0,1),
                rnorm(sum(lung$Status==1),1,1))
set.seed(1)
test_data = tibble(
  y= rnorm(1000),
  x0= geoR::rboxcox(1000, lambda=.5, mean=10, sd=2),
  x1= x0+y
)
```

# Numbered Heading

## Test covsum

```{r test-covsum-1}
rm_covsum(data=lung,
       covs=c('Status','Sex','age','AgeGroup','meal.cal','OneLevelFactor'),
              caption='Test Special characters in caption 80% $100.')

```

```{r test-covsum-2}
rm_covsum(data=lung,
       covs=c('Status','age','AgeGroup','meal.cal','OneLevelFactor'),
       maincov = 'Sex')
```

\newpage

Make sure it still works when there are empty levels

In a covariate:

```{r test-covsum-2}

test_empty <- lung
test_empty$AgeGroup[test_empty$Sex=='Female'] <- NA
  
rm_covsum(data=test_empty,
       covs=c('Status','age','AgeGroup','meal.cal','OneLevelFactor'),
       maincov = 'Sex')
```

In the main covariate:

```{r test-covsum-2}

test_empty <- lung
test_empty$Sex[test_empty$Sex=='Female'] <- NA
  
rm_covsum(data=test_empty,
       covs=c('Status','age','AgeGroup','meal.cal','OneLevelFactor'),
       maincov = 'Sex')

```

If you need to run an `rm_` function in a loop, you need to use this structure: Unfortunately, this produces a NULL after each table, which is on the todo list!

```{r results='asis',echo=T}

pander::panderOptions('knitr.auto.asis', FALSE)

for (v in names(lung)[1:2]){
    cat("\n")
    print(rm_covsum(data=lung,covs=v))
    cat("\n")
}

pander::panderOptions('knitr.auto.asis', TRUE)
```

\newpage

## Test plotuv

Figure \@ref(fig:test-plotuv) shows the bivariate relationships between the response and covariates. Figure referencing works only when a figure caption is provided in the chunk options. Note that underscores and not allowed in the chunk names, only hyphens.

```{r test-plotuv, fig.cap= 'Associations between status and covariates in the lung data.'}
plotuv(data=lung,
                covs=c('Sex','age','AgeGroup','meal.cal','OneLevelFactor'),
                response = 'Status',
                response_title = 'Test Response Title',
                showN=T
)
```

## Tests for uvsum

### Test logistic

Tables \@ref(tab:test-uv-logistic-1), \@ref(tab:test-uv-logistic-2) and \@ref(tab:test-uv-logistic-3) display the logistic regression results with different confidence interval widths. If the document in knit to pdf, the chank-lable option will not be used, instead the name of the chunk will be used in cross-referening. For Word tables the chunk label needs to be added into the function call.

```{r test-uv-logistic-1}
rm_uvsum(response = 'Status',
      covs=c('age','Sex','wt.loss'),
      data=lung,
      type='logistic',
      chunk_label = 'test-uv-logistic-1' )


```

```{r test-uv-logistic-2}
rm_uvsum(response = 'Status',
      covs=c('age'),
      data=lung,
      type='logistic',
      CIwidth=.9,
      chunk_label='test-uv-logistic-2')
```

```{r test-uv-logistic-3}
rm_uvsum(response = 'Status',
      covs=c('age'),
      data=lung,
      type='logistic',
      CIwidth=.99,
      chunk_label='test-uv-logistic-3')



```

### Test Linear
```{r test-uv-linear}
rm_uvsum(response = 'wt.loss',
      covs=c('Status','Sex','ph.ecog','meal.cal','age'),
      data=lung,
      CIwidth=.95)
rm_uvsum(response = 'wt.loss',
      covs=c('age'),
      data=lung,
      CIwidth=.90)

```

### Test coxph & ggsurv
```{r test-uv-coxph}
rm_uvsum(response = c('time','status'),
      covs=c('Sex','ph.ecog','meal.cal','age'),
      data=lung,
      CIwidth=.99)

```

\newpage

# KM plit with confidence intervals
```{r}
ggkmcif(response = c('time','status'),data=lung,median.text = T,set.time.text = 'Y OS',
        set.time = c(500,100,1100),conf.type = 'log-log',conf.curves=TRUE)

```

\newpage

# Unnumbered Heading {-}
## Test mvsum & forestplot2

```{r}
m = glm(Status~wt.loss+Sex+AgeGroup,
        data=lung,
        family='binomial')
rm_mvsum(model=m,data = lung,HolmGlobalp = T)
```

\newpage

```{r}
forestplot2(m)
```

\newpage
## Combining Tables with nestTable

```{r}
m1 = glm(Status~wt.loss+Sex,
        data=lung,
        family='binomial')
tab1 <- rm_mvsum(model=m1,data = lung,HolmGlobalp = T,tableOnly = T,showN=T)
m2 = glm(Status~wt.loss+Sex+AgeGroup,
        data=lung,
        family='binomial')
tab2 <- rm_mvsum(model=m2,data = lung,HolmGlobalp = T,tableOnly = T,showN = T)

tab1$Model = 'Model 1'
tab1$`p-value` = NA # necessary to make the columns match
tab2$Model = 'Model 2'

nestTable(data=rbind(tab1,tab2),
              head_col = 'Model',to_col = 'Covariate')




```

\newpage

# References

<!-- NOTE: This is a comment and will not appear in the final document -->

<div id="refs"></div> <!-- This is only necessary if you need something after the Reference section -->

\newpage

# Appendix

Other results can go here.

### Test crr
```{r test-uv-crr}
rm_uvsum(response = c('time','status'),
      covs=c('Sex','ph.ecog','meal.cal','age'),
      data=lung,
      type='crr',
      CIwidth=.90)

rm_uvsum(response = c('time','status'),
      covs=c('age'),
      data=lung,
      type='crr')

```

### Test boxcox
```{r test-uv-boxcox}
rm_uvsum(response = 'y',
      covs=c('x0','x1'),
      data=test_data,
      type='boxcox',
      CIwidth=.90)
```

